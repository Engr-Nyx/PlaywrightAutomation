name: Playwright Tests CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  playwright_automation_pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Build the Playwright Docker image
        id: docker_build
        run: |
          IMAGE_TAG="playwright-app:${{ github.sha }}"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          docker build . --file Dockerfile --tag $IMAGE_TAG
      - name: Run Playwright Tests and Generate Allure Report
        run: |
          docker run \
            -v ${{ github.workspace }}/allure-results:/app/allure-results \
            -v ${{ github.workspace }}/allure-report:/app/allure-report \
            -v ${{ github.workspace }}:/app \
            --workdir /app \
            ${{ env.IMAGE_TAG }} \
            /bin/bash -c "npx playwright test && allure generate allure-results --clean -o allure-report"
      # ----------------------------------------------------
      - name: Upload Allure Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report
          retention-days: 5
          if-no-files-found: ignore
          
      - name: Final Status
        run: echo "Tests finished and Allure report uploaded as an artifact."

